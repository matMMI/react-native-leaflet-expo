{"version":3,"names":["React","useCallback","useEffect","useRef","useState","WebView","readAsStringAsync","useAssets","WebViewLeafletEvents","OWN_POSTION_MARKER_ID","StyleSheet","LoadingIndicator","LEAFLET_HTML_SOURCE","index","require","html","setHtml","localUri","then","data","DEFAULT_MAP_LAYERS","attribution","baseLayerIsChecked","baseLayerName","url","DEFAULT_ZOOM","LeafletView","renderLoading","onError","onLoadEnd","onLoadStart","onMessageReceived","mapLayers","mapMarkers","mapShapes","mapCenterPosition","ownPositionMarker","zoom","doDebug","androidHardwareAccelerationDisabled","webViewRef","initialized","setInitialized","logMessage","message","console","log","sendMessage","payload","_webViewRef$current","JSON","stringify","current","injectJavaScript","sendInitialMessage","startupMessage","id","handleMessage","event","_event$nativeEvent","nativeEvent","parse","msg","MAP_READY","ON_MOVE_END","_message$payload","createElement","containerStyle","styles","container","ref","javaScriptEnabled","onMessage","domStorageEnabled","startInLoadingState","originWhitelist","source","allowFileAccess","allowUniversalAccessFromFileURLs","allowFileAccessFromFileURLs","defaultProps","__DEV__","create","flex","absoluteFillObject"],"sources":["index.tsx"],"sourcesContent":["import React, { useCallback, useEffect, useRef, useState } from 'react';\nimport { WebView } from 'react-native-webview';\nimport { readAsStringAsync } from 'expo-file-system';\nimport { useAssets } from 'expo-asset';\nimport {\n  MapMarker,\n  WebviewLeafletMessage,\n  MapMessage,\n  WebViewLeafletEvents,\n  MapLayer,\n  MapShape,\n  OwnPositionMarker,\n  OWN_POSTION_MARKER_ID,\n} from './types';\nimport { LatLng } from 'react-leaflet';\nimport { NativeSyntheticEvent, StyleSheet } from 'react-native';\nimport {\n  WebViewError,\n  WebViewMessageEvent,\n} from 'react-native-webview/lib/WebViewTypes';\nimport LoadingIndicator from '../LoadingIndicator';\n\nconst LEAFLET_HTML_SOURCE = () => {\n  const [index] = useAssets(\n    require('../../android/src/main/assets/leaflet.html')\n  );\n\n  const [html, setHtml] = useState('');\n\n  if (index) {\n    readAsStringAsync(index[0].localUri as string).then((data) => {\n      setHtml(data);\n    });\n  }\n\n  return html;\n};\n\nconst DEFAULT_MAP_LAYERS = [\n  {\n    attribution:\n      '&copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors',\n    baseLayerIsChecked: true,\n    baseLayerName: 'OpenStreetMap.Mapnik',\n    url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',\n  },\n];\n\nconst DEFAULT_ZOOM = 15;\n\nexport type LeafletViewProps = {\n  renderLoading?: () => React.ReactElement;\n  onError?: (syntheticEvent: NativeSyntheticEvent<WebViewError>) => void;\n  onLoadEnd?: () => void;\n  onLoadStart?: () => void;\n  onMessageReceived?: (message: WebviewLeafletMessage) => void;\n  mapLayers?: MapLayer[];\n  mapMarkers?: MapMarker[];\n  mapShapes?: MapShape[];\n  mapCenterPosition?: LatLng;\n  ownPositionMarker?: OwnPositionMarker;\n  zoom?: number;\n  doDebug?: boolean;\n  androidHardwareAccelerationDisabled?: boolean;\n};\n\nconst LeafletView: React.FC<LeafletViewProps> = ({\n  renderLoading,\n  onError,\n  onLoadEnd,\n  onLoadStart,\n  onMessageReceived,\n  mapLayers,\n  mapMarkers,\n  mapShapes,\n  mapCenterPosition,\n  ownPositionMarker,\n  zoom,\n  doDebug,\n  androidHardwareAccelerationDisabled,\n}) => {\n  const webViewRef = useRef<WebView>(null);\n  const [initialized, setInitialized] = useState(false);\n\n  const logMessage = useCallback(\n    (message: string) => {\n      if (doDebug) {\n        console.log(message);\n      }\n    },\n    [doDebug]\n  );\n\n  const sendMessage = useCallback(\n    (payload: MapMessage) => {\n      logMessage(`sending: ${JSON.stringify(payload)}`);\n\n      webViewRef.current?.injectJavaScript(\n        `window.postMessage(${JSON.stringify(payload)}, '*');`\n      );\n    },\n    [logMessage]\n  );\n\n  const sendInitialMessage = useCallback(() => {\n    let startupMessage: MapMessage = {};\n\n    if (mapLayers) {\n      startupMessage.mapLayers = mapLayers;\n    }\n    if (mapMarkers) {\n      startupMessage.mapMarkers = mapMarkers;\n    }\n    if (mapCenterPosition) {\n      startupMessage.mapCenterPosition = mapCenterPosition;\n    }\n    if (mapShapes) {\n      startupMessage.mapShapes = mapShapes;\n    }\n    if (ownPositionMarker) {\n      startupMessage.ownPositionMarker = {\n        ...ownPositionMarker,\n        id: OWN_POSTION_MARKER_ID,\n      };\n    }\n    startupMessage.zoom = zoom;\n\n    sendMessage(startupMessage);\n    setInitialized(true);\n    logMessage('sending initial message');\n  }, [\n    logMessage,\n    mapCenterPosition,\n    mapLayers,\n    mapMarkers,\n    mapShapes,\n    ownPositionMarker,\n    sendMessage,\n    zoom,\n  ]);\n\n  const handleMessage = useCallback(\n    (event: WebViewMessageEvent) => {\n      const data = event?.nativeEvent?.data;\n      if (!data) {\n        return;\n      }\n\n      const message: WebviewLeafletMessage = JSON.parse(data);\n      logMessage(`received: ${JSON.stringify(message)}`);\n\n      if (message.msg === WebViewLeafletEvents.MAP_READY) {\n        sendInitialMessage();\n      }\n      if (message.event === WebViewLeafletEvents.ON_MOVE_END) {\n        logMessage(\n          `moved to: ${JSON.stringify(message.payload?.mapCenterPosition)}`\n        );\n      }\n\n      onMessageReceived && onMessageReceived(message);\n    },\n    [logMessage, onMessageReceived, sendInitialMessage]\n  );\n\n  //Handle mapLayers update\n  useEffect(() => {\n    if (!initialized) {\n      return;\n    }\n    sendMessage({ mapLayers });\n  }, [initialized, mapLayers, sendMessage]);\n\n  //Handle mapMarkers update\n  useEffect(() => {\n    if (!initialized) {\n      return;\n    }\n    sendMessage({ mapMarkers });\n  }, [initialized, mapMarkers, sendMessage]);\n\n  //Handle mapShapes update\n  useEffect(() => {\n    if (!initialized) {\n      return;\n    }\n    sendMessage({ mapShapes });\n  }, [initialized, mapShapes, sendMessage]);\n\n  //Handle ownPositionMarker update\n  useEffect(() => {\n    if (!initialized || !ownPositionMarker) {\n      return;\n    }\n    sendMessage({\n      ...ownPositionMarker,\n      id: OWN_POSTION_MARKER_ID,\n    });\n  }, [initialized, ownPositionMarker, sendMessage]);\n\n  //Handle mapCenterPosition update\n  useEffect(() => {\n    if (!initialized) {\n      return;\n    }\n    sendMessage({ mapCenterPosition });\n  }, [initialized, mapCenterPosition, sendMessage]);\n\n  //Handle zoom update\n  useEffect(() => {\n    if (!initialized) {\n      return;\n    }\n    sendMessage({ zoom });\n  }, [initialized, zoom, sendMessage]);\n\n  return (\n    <WebView\n      containerStyle={styles.container}\n      ref={webViewRef}\n      javaScriptEnabled={true}\n      onLoadEnd={onLoadEnd}\n      onLoadStart={onLoadStart}\n      onMessage={handleMessage}\n      domStorageEnabled={true}\n      startInLoadingState={true}\n      onError={onError}\n      originWhitelist={['*']}\n      renderLoading={renderLoading}\n      source={{ html: LEAFLET_HTML_SOURCE() }}\n      allowFileAccess={true}\n      allowUniversalAccessFromFileURLs={true}\n      allowFileAccessFromFileURLs={true}\n      androidHardwareAccelerationDisabled={androidHardwareAccelerationDisabled}\n    />\n  );\n};\n\nLeafletView.defaultProps = {\n  renderLoading: () => <LoadingIndicator />,\n  mapLayers: DEFAULT_MAP_LAYERS,\n  zoom: DEFAULT_ZOOM,\n  doDebug: __DEV__,\n};\n\nconst styles = StyleSheet.create({\n  container: {\n    flex: 1,\n    ...StyleSheet.absoluteFillObject,\n  },\n});\n\nexport default LeafletView;\n"],"mappings":"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"}