{"version":3,"names":["_react","_interopRequireWildcard","require","_reactNativeWebview","_expoFileSystem","_expoAsset","_types","_reactNative","_LoadingIndicator","_interopRequireDefault","obj","__esModule","default","_getRequireWildcardCache","e","WeakMap","r","t","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","prototype","hasOwnProperty","call","i","set","LEAFLET_HTML_SOURCE","index","useAssets","html","setHtml","useState","readAsStringAsync","localUri","then","data","DEFAULT_MAP_LAYERS","attribution","baseLayerIsChecked","baseLayerName","url","DEFAULT_ZOOM","LeafletView","renderLoading","onError","onLoadEnd","onLoadStart","onMessageReceived","mapLayers","mapMarkers","mapShapes","mapCenterPosition","ownPositionMarker","zoom","doDebug","androidHardwareAccelerationDisabled","webViewRef","useRef","initialized","setInitialized","logMessage","useCallback","message","console","log","sendMessage","payload","_webViewRef$current","JSON","stringify","current","injectJavaScript","sendInitialMessage","startupMessage","id","OWN_POSTION_MARKER_ID","handleMessage","event","_event$nativeEvent","nativeEvent","parse","msg","WebViewLeafletEvents","MAP_READY","ON_MOVE_END","_message$payload","useEffect","createElement","WebView","containerStyle","styles","container","ref","javaScriptEnabled","onMessage","domStorageEnabled","startInLoadingState","originWhitelist","source","allowFileAccess","allowUniversalAccessFromFileURLs","allowFileAccessFromFileURLs","defaultProps","__DEV__","StyleSheet","create","flex","absoluteFillObject","_default","exports"],"sources":["index.tsx"],"sourcesContent":["import React, { useCallback, useEffect, useRef, useState } from 'react';\nimport { WebView } from 'react-native-webview';\nimport { readAsStringAsync } from 'expo-file-system';\nimport { useAssets } from 'expo-asset';\nimport {\n  MapMarker,\n  WebviewLeafletMessage,\n  MapMessage,\n  WebViewLeafletEvents,\n  MapLayer,\n  MapShape,\n  OwnPositionMarker,\n  OWN_POSTION_MARKER_ID,\n} from './types';\nimport { LatLng } from 'react-leaflet';\nimport { NativeSyntheticEvent, StyleSheet } from 'react-native';\nimport {\n  WebViewError,\n  WebViewMessageEvent,\n} from 'react-native-webview/lib/WebViewTypes';\nimport LoadingIndicator from '../LoadingIndicator';\n\nconst LEAFLET_HTML_SOURCE = () => {\n  const [index] = useAssets(\n    require('../../android/src/main/assets/leaflet.html')\n  );\n\n  const [html, setHtml] = useState('');\n\n  if (index) {\n    readAsStringAsync(index[0].localUri as string).then((data) => {\n      setHtml(data);\n    });\n  }\n\n  return html;\n};\n\nconst DEFAULT_MAP_LAYERS = [\n  {\n    attribution:\n      '&copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors',\n    baseLayerIsChecked: true,\n    baseLayerName: 'OpenStreetMap.Mapnik',\n    url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',\n  },\n];\n\nconst DEFAULT_ZOOM = 15;\n\nexport type LeafletViewProps = {\n  renderLoading?: () => React.ReactElement;\n  onError?: (syntheticEvent: NativeSyntheticEvent<WebViewError>) => void;\n  onLoadEnd?: () => void;\n  onLoadStart?: () => void;\n  onMessageReceived?: (message: WebviewLeafletMessage) => void;\n  mapLayers?: MapLayer[];\n  mapMarkers?: MapMarker[];\n  mapShapes?: MapShape[];\n  mapCenterPosition?: LatLng;\n  ownPositionMarker?: OwnPositionMarker;\n  zoom?: number;\n  doDebug?: boolean;\n  androidHardwareAccelerationDisabled?: boolean;\n};\n\nconst LeafletView: React.FC<LeafletViewProps> = ({\n  renderLoading,\n  onError,\n  onLoadEnd,\n  onLoadStart,\n  onMessageReceived,\n  mapLayers,\n  mapMarkers,\n  mapShapes,\n  mapCenterPosition,\n  ownPositionMarker,\n  zoom,\n  doDebug,\n  androidHardwareAccelerationDisabled,\n}) => {\n  const webViewRef = useRef<WebView>(null);\n  const [initialized, setInitialized] = useState(false);\n\n  const logMessage = useCallback(\n    (message: string) => {\n      if (doDebug) {\n        console.log(message);\n      }\n    },\n    [doDebug]\n  );\n\n  const sendMessage = useCallback(\n    (payload: MapMessage) => {\n      logMessage(`sending: ${JSON.stringify(payload)}`);\n\n      webViewRef.current?.injectJavaScript(\n        `window.postMessage(${JSON.stringify(payload)}, '*');`\n      );\n    },\n    [logMessage]\n  );\n\n  const sendInitialMessage = useCallback(() => {\n    let startupMessage: MapMessage = {};\n\n    if (mapLayers) {\n      startupMessage.mapLayers = mapLayers;\n    }\n    if (mapMarkers) {\n      startupMessage.mapMarkers = mapMarkers;\n    }\n    if (mapCenterPosition) {\n      startupMessage.mapCenterPosition = mapCenterPosition;\n    }\n    if (mapShapes) {\n      startupMessage.mapShapes = mapShapes;\n    }\n    if (ownPositionMarker) {\n      startupMessage.ownPositionMarker = {\n        ...ownPositionMarker,\n        id: OWN_POSTION_MARKER_ID,\n      };\n    }\n    startupMessage.zoom = zoom;\n\n    sendMessage(startupMessage);\n    setInitialized(true);\n    logMessage('sending initial message');\n  }, [\n    logMessage,\n    mapCenterPosition,\n    mapLayers,\n    mapMarkers,\n    mapShapes,\n    ownPositionMarker,\n    sendMessage,\n    zoom,\n  ]);\n\n  const handleMessage = useCallback(\n    (event: WebViewMessageEvent) => {\n      const data = event?.nativeEvent?.data;\n      if (!data) {\n        return;\n      }\n\n      const message: WebviewLeafletMessage = JSON.parse(data);\n      logMessage(`received: ${JSON.stringify(message)}`);\n\n      if (message.msg === WebViewLeafletEvents.MAP_READY) {\n        sendInitialMessage();\n      }\n      if (message.event === WebViewLeafletEvents.ON_MOVE_END) {\n        logMessage(\n          `moved to: ${JSON.stringify(message.payload?.mapCenterPosition)}`\n        );\n      }\n\n      onMessageReceived && onMessageReceived(message);\n    },\n    [logMessage, onMessageReceived, sendInitialMessage]\n  );\n\n  //Handle mapLayers update\n  useEffect(() => {\n    if (!initialized) {\n      return;\n    }\n    sendMessage({ mapLayers });\n  }, [initialized, mapLayers, sendMessage]);\n\n  //Handle mapMarkers update\n  useEffect(() => {\n    if (!initialized) {\n      return;\n    }\n    sendMessage({ mapMarkers });\n  }, [initialized, mapMarkers, sendMessage]);\n\n  //Handle mapShapes update\n  useEffect(() => {\n    if (!initialized) {\n      return;\n    }\n    sendMessage({ mapShapes });\n  }, [initialized, mapShapes, sendMessage]);\n\n  //Handle ownPositionMarker update\n  useEffect(() => {\n    if (!initialized || !ownPositionMarker) {\n      return;\n    }\n    sendMessage({\n      ...ownPositionMarker,\n      id: OWN_POSTION_MARKER_ID,\n    });\n  }, [initialized, ownPositionMarker, sendMessage]);\n\n  //Handle mapCenterPosition update\n  useEffect(() => {\n    if (!initialized) {\n      return;\n    }\n    sendMessage({ mapCenterPosition });\n  }, [initialized, mapCenterPosition, sendMessage]);\n\n  //Handle zoom update\n  useEffect(() => {\n    if (!initialized) {\n      return;\n    }\n    sendMessage({ zoom });\n  }, [initialized, zoom, sendMessage]);\n\n  return (\n    <WebView\n      containerStyle={styles.container}\n      ref={webViewRef}\n      javaScriptEnabled={true}\n      onLoadEnd={onLoadEnd}\n      onLoadStart={onLoadStart}\n      onMessage={handleMessage}\n      domStorageEnabled={true}\n      startInLoadingState={true}\n      onError={onError}\n      originWhitelist={['*']}\n      renderLoading={renderLoading}\n      source={{ html: LEAFLET_HTML_SOURCE() }}\n      allowFileAccess={true}\n      allowUniversalAccessFromFileURLs={true}\n      allowFileAccessFromFileURLs={true}\n      androidHardwareAccelerationDisabled={androidHardwareAccelerationDisabled}\n    />\n  );\n};\n\nLeafletView.defaultProps = {\n  renderLoading: () => <LoadingIndicator />,\n  mapLayers: DEFAULT_MAP_LAYERS,\n  zoom: DEFAULT_ZOOM,\n  doDebug: __DEV__,\n};\n\nconst styles = StyleSheet.create({\n  container: {\n    flex: 1,\n    ...StyleSheet.absoluteFillObject,\n  },\n});\n\nexport default LeafletView;\n"],"mappings":"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"}